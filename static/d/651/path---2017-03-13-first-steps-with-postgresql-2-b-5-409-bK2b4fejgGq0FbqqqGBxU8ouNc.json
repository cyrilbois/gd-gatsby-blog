{"data":{"site":{"siteMetadata":{"title":"Giacomo Debidda","author":"Giacomo Debidda"}},"markdownRemark":{"id":"d12fc6b3-d846-5266-a2eb-096175de4229 >>> MarkdownRemark","excerpt":"In a Django project, PostgreSQL is probably the most popular choice when it comes to deploy a database for a production environment. In this…","html":"<p>In a Django project, PostgreSQL is probably the most popular choice when it comes to deploy a database for a production environment. In this article I’ll go through the necessary steps to set it up on Ubuntu, along with a list of some basic commands to create databases and tables, as well as manage <em>roles</em> (i.e. users).</p>\n<p>Here I will create a new role called <code class=\"language-text\">test_user</code> and a new database called <code class=\"language-text\">test_db</code>. You can pick different names if you want, but try to avoid mixing lowercase/uppercase. This is because if you create a user with a mix of lowercase and uppercase characters (e.g. <code class=\"language-text\">test_User</code>) you will need to type the double quotation marks every time.</p>\n<h2>Dependencies</h2>\n<p>To satisfy the dependencies of the operative system, open a terminal and type:</p>\n<div class='midnight'><pre class=\"editor editor-colors\"><div class=\"line\"><span class=\"syntax--text syntax--plain syntax--null-grammar\"><span>sudo&nbsp;apt-get&nbsp;install&nbsp;postgresql&nbsp;postgresql-contrib&nbsp;libpq-dev&nbsp;python-dev</span></span></div></pre></div>\n<p>For the python dependencies, I’d suggest to create a virtual environment with <a href=\"https://virtualenv.pypa.io/en/stable/\">virtualenv</a>, or even better with <a href=\"http://www.giacomodebidda.com/blog/virtual-environments-with-virtualenvwrapper/\">virtualenvwrapper</a>, and install the <code class=\"language-text\">psycopg2</code> driver:</p>\n<div class='midnight'><pre class=\"editor editor-colors\"><div class=\"line\"><span class=\"syntax--text syntax--plain syntax--null-grammar\"><span>pip&nbsp;install&nbsp;psycopg2</span></span></div></pre></div>\n<h2>The postgres shell</h2>\n<p><code class=\"language-text\">psql</code> is the interactive terminal for working with PostgreSQL. You can launch it with <code class=\"language-text\">sudo -i -u postgres</code> and then <code class=\"language-text\">psql</code>.</p>\n<p>Here are some useful commands when using the <code class=\"language-text\">psql</code> shell:</p>\n<ul>\n<li><strong>\\du</strong> list all roles (namely the users) and their privileges;</li>\n<li><strong>\\l</strong> list all databases, their owners and access privileges;</li>\n<li><strong>\\c [DB NAME]</strong> connect to the <strong>[DB NAME]</strong> database with the user currently logged in;</li>\n<li><strong>\\d</strong> list all the tables of the database you are currently connected to;</li>\n<li><strong>\\d [TABLE NAME]</strong> show the schema of the table <strong>[TABLE NAME]</strong>, of the database you are currently connected to;</li>\n<li><strong>\\h</strong> help on SQL commands;</li>\n<li><strong>?</strong> help on psql commands;</li>\n<li><strong>\\conninfo</strong> show some information about the current database connection (db name and user name);</li>\n<li><strong>\\q</strong> exit the psql shell.</li>\n</ul>\n<h2>Create a new user (aka role)</h2>\n<p>PostgreSQL comes with a default user called <code class=\"language-text\">postgres</code>, which is the root user. Let’s create a new user.</p>\n<p>As user <code class=\"language-text\">postgres</code>, exit the <code class=\"language-text\">psql</code> shell and type:</p>\n<div class='midnight'><pre class=\"editor editor-colors\"><div class=\"line\"><span class=\"syntax--text syntax--plain syntax--null-grammar\"><span>createuser&nbsp;--interactive</span></span></div></pre></div>\n<p>Choose a username (e.g. <code class=\"language-text\">test_user</code>) and decide wheter this user should be a superuser, should be allowed to create new databases and/or new roles.</p>\n<div class='midnight'><pre class=\"editor editor-colors\"><div class=\"line\"><span class=\"syntax--text syntax--plain syntax--null-grammar\"><span>Enter&nbsp;name&nbsp;of&nbsp;role&nbsp;to&nbsp;add:&nbsp;test_user</span></span></div><div class=\"line\"><span class=\"syntax--text syntax--plain syntax--null-grammar\"><span>Shall&nbsp;the&nbsp;new&nbsp;role&nbsp;be&nbsp;a&nbsp;superuser?&nbsp;(y/n)&nbsp;n</span></span></div><div class=\"line\"><span class=\"syntax--text syntax--plain syntax--null-grammar\"><span>Shall&nbsp;the&nbsp;new&nbsp;role&nbsp;be&nbsp;allowed&nbsp;to&nbsp;create&nbsp;databases?&nbsp;(y/n)&nbsp;y</span></span></div><div class=\"line\"><span class=\"syntax--text syntax--plain syntax--null-grammar\"><span>Shall&nbsp;the&nbsp;new&nbsp;role&nbsp;be&nbsp;allowed&nbsp;to&nbsp;create&nbsp;more&nbsp;new&nbsp;roles?&nbsp;(y/n)&nbsp;y</span></span></div></pre></div>\n<p>If you want to check that the user was created correctly, go back to the <code class=\"language-text\">psql</code> shell and type <code class=\"language-text\">\\du</code>.</p>\n<h2>Assign a password to your new user</h2>\n<p>In the <code class=\"language-text\">psql</code> shell, type:</p>\n<div class='midnight'><pre class=\"editor editor-colors\"><div class=\"line\"><span class=\"syntax--source syntax--sql\"><span class=\"syntax--meta syntax--alter syntax--sql\"><span class=\"syntax--keyword syntax--other syntax--create syntax--sql\"><span>ALTER</span></span><span>&nbsp;</span><span class=\"syntax--keyword syntax--other syntax--table syntax--sql\"><span>USER</span></span><span>&nbsp;</span></span><span>test_user&nbsp;WITH&nbsp;PASSWORD&nbsp;</span><span class=\"syntax--string syntax--quoted syntax--single syntax--sql\"><span class=\"syntax--punctuation syntax--definition syntax--string syntax--begin syntax--sql\"><span>&#39;</span></span><span>test_password&#39;</span></span><span>;</span></span></div></pre></div>\n<p>Don’t forget the semi-colon and <a href=\"http://blog.lerner.co.il/quoting-postgresql/\">avoid double quotation marks</a>.</p>\n<h2>Create a database</h2>\n<p>In the <code class=\"language-text\">psql</code> shell, as user <code class=\"language-text\">postgres</code>, type:</p>\n<div class='midnight'><pre class=\"editor editor-colors\"><div class=\"line\"><span class=\"syntax--source syntax--sql\"><span class=\"syntax--meta syntax--create syntax--sql\"><span class=\"syntax--keyword syntax--other syntax--create syntax--sql\"><span>CREATE</span></span><span>&nbsp;</span><span class=\"syntax--keyword syntax--other syntax--sql\"><span>DATABASE</span></span><span>&nbsp;</span><span class=\"syntax--entity syntax--name syntax--function syntax--sql\"><span>test_db</span></span></span><span>;</span></span></div></pre></div>\n<p>This command creates a new database called <code class=\"language-text\">test_db</code>. At this moment, only the user <code class=\"language-text\">postgres</code> can perform operations on this database.</p>\n<h2>Create a table</h2>\n<div class='midnight'><pre class=\"editor editor-colors\"><div class=\"line\"><span class=\"syntax--source syntax--sql\"><span class=\"syntax--meta syntax--create syntax--sql\"><span class=\"syntax--keyword syntax--other syntax--create syntax--sql\"><span>CREATE</span></span><span>&nbsp;</span><span class=\"syntax--keyword syntax--other syntax--sql\"><span>TABLE</span></span><span>&nbsp;</span><span class=\"syntax--entity syntax--name syntax--function syntax--sql\"><span>items</span></span></span><span>(</span></span></div><div class=\"line\"><span class=\"syntax--source syntax--sql\"><span>&nbsp;&nbsp;&nbsp;&nbsp;item_id&nbsp;</span><span class=\"syntax--storage syntax--type syntax--sql\"><span>serial</span></span><span>&nbsp;</span><span class=\"syntax--storage syntax--modifier syntax--sql\"><span>PRIMARY&nbsp;KEY</span></span><span>,</span></span></div><div class=\"line\"><span class=\"syntax--source syntax--sql\"><span>&nbsp;&nbsp;&nbsp;&nbsp;item_description&nbsp;</span><span class=\"syntax--storage syntax--type syntax--sql\"><span>text</span></span><span>&nbsp;</span><span class=\"syntax--keyword syntax--other syntax--DDL syntax--create syntax--II syntax--sql\"><span>NOT&nbsp;NULL</span></span><span>,</span></span></div><div class=\"line\"><span class=\"syntax--source syntax--sql\"><span>&nbsp;&nbsp;&nbsp;&nbsp;item_added&nbsp;</span><span class=\"syntax--storage syntax--type syntax--sql\"><span>timestamp</span></span><span>&nbsp;DEFAULT&nbsp;</span><span class=\"syntax--keyword syntax--other syntax--DDL syntax--create syntax--II syntax--sql\"><span>NULL</span></span></span></div><div class=\"line\"><span class=\"syntax--source syntax--sql\"><span>);</span></span></div></pre></div>\n<h2>Assign privileges to <code class=\"language-text\">test_user</code></h2>\n<p>You need to allow your new user to modify the content of the <code class=\"language-text\">test_db</code> database. In order to do so you will need to grant him privileges on the database itself, and on the tables available in the database.</p>\n<div class='midnight'><pre class=\"editor editor-colors\"><div class=\"line\"><span class=\"syntax--source syntax--sql\"><span class=\"syntax--keyword syntax--other syntax--authorization syntax--sql\"><span>GRANT</span></span><span>&nbsp;ALL&nbsp;PRIVILEGES&nbsp;</span><span class=\"syntax--keyword syntax--other syntax--DDL syntax--create syntax--II syntax--sql\"><span>ON</span></span><span>&nbsp;DATABASE&nbsp;test_db&nbsp;TO&nbsp;test_user;</span></span></div></pre></div>\n<p>The main reason to grant privileges on the database is to allow or revoke the connection to the database, but in order to allow for changes in the content of the database itself, the user <code class=\"language-text\">test_user</code> needs the privileges on all the tables he is allowed to modify. So, if you want to allow <code class=\"language-text\">test_user</code> to edit the contents of the table <code class=\"language-text\">items</code>, connect to the database with <code class=\"language-text\">\\c test_db</code> and assign the privileges with:</p>\n<div class='midnight'><pre class=\"editor editor-colors\"><div class=\"line\"><span class=\"syntax--source syntax--sql\"><span class=\"syntax--keyword syntax--other syntax--authorization syntax--sql\"><span>GRANT</span></span><span>&nbsp;ALL&nbsp;PRIVILEGES&nbsp;</span><span class=\"syntax--keyword syntax--other syntax--DDL syntax--create syntax--II syntax--sql\"><span>ON</span></span><span>&nbsp;TABLE&nbsp;items&nbsp;TO&nbsp;test_user;</span></span></div></pre></div>\n<p>Instead of typing the two aforementioned commands, you can achieve the same result with a single command:</p>\n<div class='midnight'><pre class=\"editor editor-colors\"><div class=\"line\"><span class=\"syntax--source syntax--sql\"><span class=\"syntax--keyword syntax--other syntax--authorization syntax--sql\"><span>GRANT</span></span><span>&nbsp;ALL&nbsp;</span><span class=\"syntax--keyword syntax--other syntax--DDL syntax--create syntax--II syntax--sql\"><span>ON</span></span><span>&nbsp;items&nbsp;TO&nbsp;test_user;</span></span></div></pre></div>\n<p>Ok, now <code class=\"language-text\">test_user</code> can connect to <code class=\"language-text\">test_db</code> and change its content. If he is the only user allowed to work on this database, it make sense to make him the owner:</p>\n<div class='midnight'><pre class=\"editor editor-colors\"><div class=\"line\"><span class=\"syntax--source syntax--sql\"><span class=\"syntax--meta syntax--alter syntax--sql\"><span class=\"syntax--keyword syntax--other syntax--create syntax--sql\"><span>ALTER</span></span><span>&nbsp;</span><span class=\"syntax--keyword syntax--other syntax--table syntax--sql\"><span>DATABASE</span></span><span>&nbsp;</span></span><span>test_db&nbsp;OWNER&nbsp;TO&nbsp;test_user;</span></span></div></pre></div>\n<h2>Connect to <code class=\"language-text\">test_db</code> with <code class=\"language-text\">test_user</code></h2>\n<p>You are still connected as user <code class=\"language-text\">postgres</code>. Exit the <code class=\"language-text\">psql</code> shell with <code class=\"language-text\">\\q</code> and log in with <code class=\"language-text\">test_user</code> (you will need to type the password).</p>\n<div class='midnight'><pre class=\"editor editor-colors\"><div class=\"line\"><span class=\"syntax--text syntax--plain syntax--null-grammar\"><span>psql&nbsp;-h&nbsp;localhost&nbsp;-U&nbsp;test_user&nbsp;-d&nbsp;test_db</span></span></div></pre></div>\n<p>Here is what you should see if you type <code class=\"language-text\">\\conninfo</code>:</p>\n<div class='midnight'><pre class=\"editor editor-colors\"><div class=\"line\"><span class=\"syntax--text syntax--plain syntax--null-grammar\"><span>test_db=&gt;&nbsp;\\conninfo</span></span></div><div class=\"line\"><span class=\"syntax--text syntax--plain syntax--null-grammar\"><span>You&nbsp;are&nbsp;connected&nbsp;to&nbsp;database&nbsp;&quot;test_db&quot;&nbsp;as&nbsp;user&nbsp;&quot;test_user&quot;&nbsp;on&nbsp;host&nbsp;&quot;localhost&quot;&nbsp;at&nbsp;port&nbsp;&quot;5432&quot;.</span></span></div><div class=\"line\"><span class=\"syntax--text syntax--plain syntax--null-grammar\"><span>SSL&nbsp;connection&nbsp;(protocol:&nbsp;TLSv1.2,&nbsp;cipher:&nbsp;ECDHE-RSA-AES256-GCM-SHA384,&nbsp;bits:&nbsp;256,&nbsp;compression:&nbsp;off)</span></span></div></pre></div>\n<h2>Cleanup</h2>\n<p>Probably you don’t want to keep the user, the database and the table we have just created, so let’s remove them. Keep in mind that you cannot drop an open database, nor you can drop it if you are not the database owner or a superuser. So, exit the <code class=\"language-text\">psql</code> shell and re-log into it as user <code class=\"language-text\">postgres</code> (you just have to type <code class=\"language-text\">psql</code>).</p>\n<div class='midnight'><pre class=\"editor editor-colors\"><div class=\"line\"><span class=\"syntax--source syntax--sql\"><span class=\"syntax--meta syntax--drop syntax--sql\"><span class=\"syntax--keyword syntax--other syntax--create syntax--sql\"><span>DROP</span></span><span>&nbsp;</span><span class=\"syntax--keyword syntax--other syntax--sql\"><span>TABLE</span></span></span><span>&nbsp;items;</span></span></div><div class=\"line\"><span class=\"syntax--source syntax--sql\"><span class=\"syntax--meta syntax--drop syntax--sql\"><span class=\"syntax--keyword syntax--other syntax--create syntax--sql\"><span>DROP</span></span><span>&nbsp;</span><span class=\"syntax--keyword syntax--other syntax--sql\"><span>DATABASE</span></span></span><span>&nbsp;test_db;</span></span></div><div class=\"line\"><span class=\"syntax--source syntax--sql\"><span class=\"syntax--meta syntax--drop syntax--sql\"><span class=\"syntax--keyword syntax--other syntax--create syntax--sql\"><span>DROP</span></span><span>&nbsp;</span><span class=\"syntax--keyword syntax--other syntax--sql\"><span>USER</span></span></span><span>&nbsp;test_user;</span></span></div></pre></div>\n<h2>References</h2>\n<p>Here are some additional resources:</p>\n<ul>\n<li><a href=\"http://postgresguide.com/utilities/psql.html\">psql</a></li>\n<li><a href=\"https://www.digitalocean.com/community/tutorials/how-to-secure-postgresql-on-an-ubuntu-vps\">How to secure PostgreSQL on a Ubuntu VPS</a></li>\n<li><a href=\"https://www.digitalocean.com/community/tutorials/how-to-back-up-restore-and-migrate-postgresql-databases-with-barman-on-centos-7\">backup and restore postgreSQL databases with Barman</a></li>\n</ul>","frontmatter":{"title":"First steps with PostgreSQL","date":"March 13, 2017"}}},"pageContext":{"slug":"/2017-03-13-first-steps-with-postgresql/","previous":{"fields":{"slug":"/2017-03-13-multiply-your-python-unit-test-cases-with-ddt/"},"frontmatter":{"title":"Multiply your Python Unit Test Cases with DDT"}},"next":{"fields":{"slug":"/2017-04-02-mvc-pattern-in-python-introduction-and-basicmodel/"},"frontmatter":{"title":"MVC pattern in Python: Introduction and BasicModel"}}}}